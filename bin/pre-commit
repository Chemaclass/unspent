#!/usr/bin/env bash
#
# Pre-commit hook - fast feedback for local development.
#
# Runs CS-Fixer and PHPUnit only (~2s cached).
# Rector and PHPStan run in CI for thoroughness.
#
# Install by running:
#   ln -sf ../../bin/pre-commit .git/hooks/pre-commit
#
# Or run manually:
#   bin/pre-commit
#
# Bypass with: git commit --no-verify

set -e

# Resolve the real path of the script (follows symlinks)
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || realpath "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_ROOT"

echo "Running pre-commit checks..."
echo ""

# Fast checks only - CS-Fixer and PHPUnit
# Rector and PHPStan deferred to CI for speed
if ! composer check:quick; then
    echo ""
    echo "Pre-commit checks failed. Please fix the issues above before committing."
    echo ""
    echo "To run full checks (including Rector and PHPStan):"
    echo "  composer test"
    echo ""
    echo "To bypass this hook (not recommended):"
    echo "  git commit --no-verify"
    exit 1
fi

echo ""
echo "Pre-commit checks passed!"
echo ""
echo "Note: Rector and PHPStan run in CI. For local full check: composer test"
